#!/bin/bash

# This file was generated by Ansible for {{ansible_fqdn}}
# Do NOT modify this file by hand!
set -e

do_sendmail() {
    command -v mail || return 1
    echo -e "$1" | mail -s "[{{inventory_hostname}}]PULL" "{{ pull_mail_to|default(pull_mail_to) }}"
}

send_graphite_start() {
    graphite_host=$1
    commit=$2
    if [ "$graphite_host" != "" ]; then
      hostname=`hostname`
      tags="$hostname,{{pull_graphite_tags|join(',')}},started"
      what="Ansible - provision started"
      timestamp=`date`
      EVENT_DATA="Started at ${timestamp}. Git commit: ${commit}"

      event="{\"what\": \"$what\", \"tags\": \"$tags\", \"data\": \"$EVENT_DATA\"}"

      set +e #if it fails, ignore it
      curl --silent --show-error --max-time 5 -X POST "$graphite_host/events/" -d "$event"
      set -e
    fi
}

send_graphite_end() {
    graphite_host=$1
    commit=$2
    if [ "$graphite_host" != "" ]; then
      hostname=`hostname`
      tags="$hostname,{{pull_graphite_tags|join(',')}},ended"
      what="Ansible - provision ended"
      timestamp=`date`
      EVENT_DATA="Ended at ${timestamp}. Git commit: ${commit}"

      event="{\"what\": \"$what\", \"tags\": \"$tags\", \"data\": \"$EVENT_DATA\"}"

      set +e #if it fails, ignore it
      curl --silent --show-error --max-time 5 -X POST "$graphite_host/events/" -d "$event"
      set -e
    fi
}

do_simple_pull() {
    local prefix="$1"
    local repo="$2"
    local galaxy_requirements="$3"
    local playbook="$4"
    local key="$5"
    local logfile="$6"
    local version="$7"
    local changed="$8"

    touch $logfile
    echo "SIMPLE PULL: Start $(date)" >> $logfile

    echo "SIMPLE PULL: Copy private key" >> $logfile
    cp -f ~/.ssh/$key ~/.ssh/id_rsa

    if [ ! -d $prefix ]; then
      echo "SIMPLE PULL: Clone $repo:$version to $prefix" >> $logfile
      git clone -b $version $repo $prefix >> $logfile 2>&1
    else
      echo "SIMPLE PULL: Pull Git repository at $prefix" >> $logfile
      cd $prefix
      git pull --rebase >> $logfile 2>&1
    fi

    cd $prefix

    commit=`git rev-parse HEAD`
    echo "SIMPLE PULL: Current commit: ${commit}" >> $logfile

    if [ ! -f $galaxy_requirements ]; then
      "SIMPLE PULL: No $galaxy_requirements file found!"
      exit 2
    fi

    send_graphite_start "{{graphite_host}}" $commit >> $logfile 2>&1

    echo "SIMPLE PULL: install Galaxy requirements $galaxy_requirements" >> $logfile
    ansible-galaxy install --role-file=$galaxy_requirements --force --ignore-errors >> $logfile 2>&1

    inventory="$prefix.ini"
    echo "SIMPLE PULL: Run playbook $playbook with $inventory inventory" >> $logfile

    start_time=$(date +%s%N);
    ansible-playbook -i $inventory $playbook --extra-vars=@$prefix.json >> $logfile 2>&1
    duration_ms=$((($(date +%s%N) - $start_time)/1000000));

    send_graphite_end "{{graphite_host}}" $commit >> $logfile 2>&1

    echo "SIMPLE PULL: Done! $(date)" >> $logfile

}

# Restore PATH
export PATH=$PATH:/usr/local/sbin:/usr/local/bin:/sbin:/bin:/usr/sbin:/usr/bin

{% for app in pull_sources %}

{% set logfile = pull_logdir + '/' + app.name + '.log' -%}
{% set repo = app.repo|default(pull_repo) -%}
{% set playbook = app.playbook|default(pull_playbook) -%}
{% set key = app.key|default(None) -%}
{% set galaxy_requirements = app.galaxy_requirements|default(None) -%}
{% if not key and pull_private_keys %}{% set key = pull_private_keys[0]|basename %}{% endif %}
{% if not key and pull_private_key %}{% set key = 'simple-pull' %}{% endif %}
{% if repo and playbook and key and galaxy_requirements %}

# Check updates for {{app.name}}
# =================={{ "=" * app.name|length }}

do_simple_pull {{pull_workdir}}/{{app.name}} {{repo}} {{galaxy_requirements}} {{playbook}} {{key}} {{logfile}} {{app.version|default(pull_version)}} {{"-o" if app.only_if_changed|default(pull_only_if_changed) else ""}}

{% endif %}
{% endfor %}


exit $?
